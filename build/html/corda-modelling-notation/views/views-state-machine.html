<!-- If you edit this, then please make the same changes to layout_for_doc_website.html, as that is used for the web
     doc site generation which we put analytics tracking on to identify any potential problem pages  -->


<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>State Machine (Ledger) &mdash; Corda Solutions Site October 2018 documentation</title><link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="State Evolution (Ledger)" href="views-state-evolution.html" />
    <link rel="prev" title="Common Concepts" href="views-common-concepts.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

            <a href="../../index.html" class="icon icon-home"> Corda Solutions Site
          </a>
              <div class="version">
                October 2018
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Business Networks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../business-networks/intro.html">Corda Business Networks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/what-is-a-business-network.html">What is a Business Network?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/how-do-business-networks-start.html">How Do Business Networks Start?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/how-do-business-networks-start.html#top-down-business-led">Top-Down (Business-Led)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/how-do-business-networks-start.html#bottom-up-technology-led">Bottom-Up (Technology-Led)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/how-do-business-networks-start.html#adoptive">Adoptive</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/roles-and-responsibilities.html">Roles and Responsibilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/roles-and-responsibilities.html#business-network-governor-bng">Business Network Governor (BNG)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/roles-and-responsibilities.html#business-network-operator-bno">Business Network Operator (BNO)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/roles-and-responsibilities.html#business-network-user-bnu">Business Network User (BNU)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/business-network-operator-node.html">Business Network Operator Node</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#business-network-operator-services">Business Network Operator Services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#membership-management">Membership Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#master-data-management">Master Data Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#authorisation">Authorisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#monitoring-reporting">Monitoring &amp; Reporting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#announcements-signaling">Announcements &amp; Signaling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-operator-node.html#software-distribution">Software Distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/interoperability.html">Interoperability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../business-networks/business-network-playbook/intro.html">Business Network Playbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/business-network-playbook/structure.html">S. Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/structure.html#s-1-define-business-network-mission">S.1. Define Business Network Mission</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/structure.html#s-2-assign-business-network-roles">S.2. Assign Business Network Roles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/structure.html#s-3-define-the-governance-body-model">S.3. Define the Governance Body Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html">G. Governance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-1-describe-participants">G.1. Describe Participants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-2-define-the-asset-model">G.2. Define the Asset Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-2-define-the-business-process">G.2. Define the Business Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-4-outline-legal-and-regulatory-needs">G.4. Outline Legal and Regulatory Needs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-5-establish-the-network-financial-model">G.5. Establish the Network Financial Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-6-establish-data-privacy-policies">G.6. Establish Data Privacy Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-7-establish-data-retention-policies">G.7. Establish Data Retention policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-8-establish-data-resiliency-and-system-availability-policies">G.8. Establish Data Resiliency and System Availability Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-9-assert-data-and-or-processing-standards">G.9. Assert Data and/or Processing Standards</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-10-establish-transaction-validation-policies">G.10. Establish Transaction Validation Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-11-establish-dispute-management-policies">G.11. Establish Dispute Management Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-12-establish-on-boarding-policies">G.12. Establish On-boarding Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-13-establish-off-boarding-policies">G.13. Establish Off-boarding Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-14-establish-inter-network-policies">G.14. Establish Inter-Network Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-15-define-performance-slas">G.15. Define Performance SLAs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-16-establish-change-management-policies">G.16. Establish Change Management Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-16-1-business-network-role-changes">G.16.1. Business Network Role Changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-16-2-business-network-legal-agreement-changes">G.16.2. Business Network Legal Agreement Changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-16-3-corda-platform-change-management-rules">G.16.3. Corda Platform Change Management Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/governance.html#g-16-4-cordapp-change-management-rules">G.16.4. CorDapp Change Management Rules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html">O. Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-1-devise-node-configuration">O.1. Devise Node Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-2-notary-configuration">O.2. Notary Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-3-oracle-configuration">O.3. Oracle Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-4-create-change-management-procedures">O.4. Create change management procedures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-5-establish-operational-times">O.5. Establish Operational Times</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-6-establish-monitoring-metrics">O.6. Establish monitoring metrics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-7-define-audit-report-and-documentation-requirements">O.7. Define audit, report and documentation requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-8-define-the-network-support-parameters">O.8. Define the network support parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../business-networks/business-network-playbook/operations.html#o-9-define-data-retention-and-pruning-procedures">O.9. Define Data Retention and Pruning Procedures</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Software Designs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../designs/business-networks-membership-service.html">Business Network Membership Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#glossary">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#scope">Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#timeline">Timeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#assumptions">Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#target-solution">Target solution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#on-boarding">On-boarding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../designs/business-networks-membership-service.html#request">Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../designs/business-networks-membership-service.html#activation">Activation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#revocation">Revocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#metadata-updates">Metadata updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#membership-list-snapshot">Membership list snapshot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#membership-list-distribution">Membership list distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../designs/business-networks-membership-service.html#membership-verification">Membership verification</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/business-networks-membership-service.html#api-extension-points">API extension points</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html">Ledger Synchronisation Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#glossary">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#scope">Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#timeline">Timeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#assumptions">Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#target-solution">Target solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../designs/ledger-synchronisation-service.html#api-extension-points">API extension points</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">CorDapp Design Language</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/overview-overview.html">Overview of CDL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview/overview-whycdl.html">Why CorDapp Design Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/overview-aims.html">Aims of CorDap Design Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/overview-views.html">CorDapp Design Language Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/overview-privacy.html">Analysing Privacy in CDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/overview-complexity.html">Managing Complexity with CDL</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="views-overview.html">CDL Views</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="views-common-concepts.html">Common Concepts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="views-common-concepts.html#defining-terms">Defining Terms</a></li>
<li class="toctree-l3"><a class="reference internal" href="views-common-concepts.html#representing-states">Representing States</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">State Machine (Ledger)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#analogy-to-a-finite-state-machine">Analogy to a Finite State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-model">Basic model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#introducing-constraints">Introducing Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transitions-constraints">Transitions Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#state-level-constraints">State Level Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transaction-level-constraints">Transaction Level Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#required-signers-constraints">Required Signers Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visibility-constraints">Visibility Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiplicity-constraints">Multiplicity Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mapping-to-the-code">Mapping to the code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#putting-it-together">Putting it together</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="views-state-evolution.html">State Evolution (Ledger)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="views-state-evolution.html#basic-state-evolution-diagram">Basic State Evolution Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="views-state-evolution.html#reference-state">Reference State</a></li>
<li class="toctree-l3"><a class="reference internal" href="views-state-evolution.html#explicit-transactions">Explicit Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="views-state-evolution.html#branching-transitions">Branching Transitions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="views-state-instance.html">States Instance (Ledger)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views-bpmn.html">BPMN (Orchestration)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views-transaction-instance.html">Transaction Instance (Orchestration)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views-flow-sequence.html">Flow Sequence (Orchestration)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../high-level-architecture/arch-overview.html">High Level Architecture Views</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../high-level-architecture/arch-high_level_process.html">High Level Process Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../high-level-architecture/arch-corda-network.html">High Level Corda Network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../privacy/privacy-overview.html">Analysing Privacy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../privacy/privacy-why-model.html">Why Model Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privacy/privacy-analysing.html">Analysing Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privacy/privacy-expressing-requirements.html">Expressing Privacy Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../complexity/complexity-overview.html">Managing Complexity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../complexity/complexity-flow-coupling.html">Flow Level Coupling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complexity/complexity-commands-coupling.html">Coupling Via Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complexity/complexity-stateref-coupling.html">Coupling to a State Instance via StateRefs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complexity/complexity-linearid-coupling.html">Coupling to a State’s Evolution via Linear Id</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Design Patterns</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../design-patterns/patterns/patterns-overview.html">CorDapp Design Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../design-patterns/patterns/receipts.html">Receipts Pattern</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#problem">Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#salient-factors">Salient Factors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#solution-walkthrough">Solution Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#privacy-analysis">Privacy Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#extensions">Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#things-to-consider-when-using-the-receipts-pattern">Things to Consider when using the Receipts pattern</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/receipts.html#related-anti-patterns">Related Anti-patterns</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html">Token Receipts Pattern</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#problem">Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#salient-factors">Salient Factors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#solution-walkthrough">Solution Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#privacy-analysis">Privacy Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design-patterns/patterns/token-receipts.html#extensions-to-investigate">Extensions - to investigate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../design-patterns/antipatterns/antipatterns-overview.html">CorDapp Anti-Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../design-patterns/antipatterns/dual-roles-for-nodes.html">Dual roles for nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-patterns/antipatterns/check-ownership-of-all-input-states.html">Check ownership of all input states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-patterns/antipatterns/unknown-commands.html">Unknown Commands</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Deployment Patterns</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/intro.html">Deployment options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/onprem/intro.html">On-Premises Deployment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/bank-deploy-overview.html">Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/bank-deploy-overview.html#stakeholders">Stakeholders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/corda-node-architecture-components.html">Architecture Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/prerequisites-sizing.html">Prerequisites and Sizing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/prerequisites-sizing.html#corda-node-bridge-and-float">Corda Node, Bridge and Float</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/prerequisites-sizing.html#vault-database">Vault - Database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html">Installation and Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#non-ha-corda-node-bridge-float">Non HA Corda Node, Bridge, Float</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#ha-corda-node-bridge-float">HA Corda Node, Bridge, Float</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#java-8-installation-on-vm">Java 8 Installation on VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#node-installation">Node Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#corda-firewall-pki-implementation">Corda Firewall PKI Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#explanation-of-pki-keys">Explanation of PKI Keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#generate-bridge-and-float-keystores">Generate Bridge and Float Keystores</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#bridge-installation">Bridge Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#float-installation">Float Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#corda-3-x-vs-corda-4-x-firewall-upgrade">Corda 3.x vs Corda 4.x Firewall Upgrade</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#port-policy-and-network-configuration">Port Policy and Network Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-firewall-deployment.html#proxy-configurations">Proxy Configurations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/node-registration.html">Node Registration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-registration.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/node-registration.html#registration-actions">Registration Actions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/start-components.html">Start Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/start-components.html#starting-float">Starting Float</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/start-components.html#starting-corda-node">Starting Corda Node</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/start-components.html#starting-bridge">Starting Bridge</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/monitoring.html">Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/corda-network-access-details.html">Important Corda Network Details</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/additional-info.html">Additional information</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/concepts-background-information.html">Why Deploy Corda Firewall?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/flagdays.html">Corda Network Considerations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/kill-flow.html">Corda Flow Kill</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/kill-flow.html#how-to-kill-a-stuck-flow">How to Kill a stuck flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/kill-flow.html#how-to-create-stuck-flow">How to create stuck flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html">Corda Health Checker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#list-of-checks">List of Checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#report-format">Report Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#disabling-the-corda-health-survey-in-production">Disabling the Corda Health Survey in Production</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#running-the-corda-health-survey">Running the Corda Health Survey</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/onprem/corda-health-checker.html#example-failure-scenario">Example Failure Scenario</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/kubernetes/intro.html">Corda Kubernetes Deployment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/kubernetes/considerations.html">Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html">Architecture overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#architecture-explanation">Architecture explanation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#demilitarized-zone-dmz">Demilitarized Zone (DMZ)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#corda-firewall-bridge-float">Corda Firewall (Bridge &amp; Float)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#socks-and-http-proxies">SOCKS and HTTP Proxies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#kubernetes-cluster">Kubernetes Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#connections-communication-protocols">Connections &amp; Communication Protocols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#connection-sequence">Connection Sequence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/architecture-overview.html#internal-kubernetes-cluster-details">Internal Kubernetes Cluster Details</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/kubernetes/prerequisites.html">Corda Kubernetes Deployment Prerequisites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/prerequisites.html#setup">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/prerequisites.html#docker-image-generation">Docker image generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/prerequisites.html#public-key-infrastructure-pki-generation">Public Key Infrastructure (PKI) generation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../deployment/kubernetes/corda-kubernetes-deployment.html">Corda Kubernetes Deployment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/corda-kubernetes-deployment.html#registration-certificate-generation">Registration / Certificate Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/corda-kubernetes-deployment.html#cordapps">CorDapps</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/corda-kubernetes-deployment.html#deployment">Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../deployment/kubernetes/corda-kubernetes-deployment.html#execution-and-testing">Execution and testing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently asked questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#what-is-this-site-for">What is this site for?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#where-did-all-the-content-come-from">Where did all the content come from?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Corda Solutions Site</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="views-overview.html">CDL Views</a></li>
      <li class="breadcrumb-item active">State Machine (Ledger)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/corda-modelling-notation/views/views-state-machine.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="state-machine-ledger">
<h1>State Machine (Ledger)</h1>
<div class="section" id="analogy-to-a-finite-state-machine">
<h2>Analogy to a Finite State Machine</h2>
<p>The Corda Ledger consists of the totality of the unconsumed States in the Compatibility Zone.
From the point of view of a Party on the Network, the Ledger consists of all the States in the Party’s own vault. The Ledger can only evolve by the consumption of current States and the creation of new States in a valid Corda Transaction.</p>
<p>The Contracts attached to the Corda States impose a set of constraints which need to pass in order for the transaction to be valid. The constraints imposed by the Contract will depend on the Status of the consumed (input) and created (output) States in the transaction. For example, if a State has a status of ‘Closed’ it may not be allowed to be an input in a ‘Transfer’ transaction.</p>
<p>So, we have the Ledger State, then a set of allowed transitions to get to the new Ledger state of the ledger. This is similar to the idea of a Finite State Machine which forms the basis of this view.</p>
<p>However, analysing the entire Corda Ledger, even from the perspective of one CorDapp, as one big Finite State Machine is not practical. Instead we will model the behaviour of a single State. Later we will look at how different State types and different instances of the same State type can interact with each other.</p>
<p>UML (Unified Modelling Language) provides a notation for modelling Finite State Machines: <a class="reference external" href="https://en.wikipedia.org/wiki/UML_state_machine">https://en.wikipedia.org/wiki/UML_state_machine</a>. The UML State Machine representation is the starting point for the CDL State Machine View, although there are some required modifications.</p>
</div>
<div class="section" id="basic-model">
<h2>Basic model</h2>
<p>The State Machine view aims to map out all of the possible ways that a State can evolve under the constraints imposed by its associated Contract.</p>
<p>Let’s take a simplified example:</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Simplified_example.png"><img alt="../../_images/CMN2_SM_Simplified_example.png" class="align-center" src="../../_images/CMN2_SM_Simplified_example.png" style="width: 80%;" /></a>
<ol class="arabic simple">
<li>Scope:</li>
</ol>
<blockquote>
<div>Defines the State which is being modelled and the Contract which is constraining the evolution of the State. These must be defined as a pair, if you change either the State or the Contract then the possible Statuses and the constraints over the transitions will change and hence the model will also change.</div></blockquote>
<ol class="arabic simple" start="2">
<li>Status:</li>
</ol>
<blockquote>
<div>A State can be in potentially many different Statuses. Status could be defined by a field called ‘Status’ or more generally a combination of the values of the properties of the State.  Not all possible statuses need to have their own box, similar statuses should be grouped such that all possible statues in the group don’t change the constraints applied. So, if a State has a possible status ‘Banana1’ and ‘Banana2’ but both have the same constraints, there is no need to have separate boxes on the diagram, both statues will behave in the same way.</div></blockquote>
<ol class="arabic simple" start="3">
<li>Command:</li>
</ol>
<blockquote>
<div>From a particular Status there may be many permitted transitions. Corda Commands parameterise and describe specific transitions and allow different constraints to be applied depending on the Transaction Command.</div></blockquote>
<ol class="arabic simple" start="4">
<li>No State:</li>
</ol>
<blockquote>
<div>Indicates that there is no State (of this State type) at the beginning of this transition.</div></blockquote>
<ol class="arabic simple" start="5">
<li>Potential Transactions</li>
</ol>
<blockquote>
<div>Each of the transitions can, but not necessarily will, be enacted as a Corda transaction. The Status at the start of the arrow is an input state and the status at the end of the arrow is an output state. For the transition from Draft to Agreed, the Transaction Instance view would look as follows (simplified):</div></blockquote>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Transaction_equivalent.png"><img alt="../../_images/CMN2_SM_Transaction_equivalent.png" class="align-center" src="../../_images/CMN2_SM_Transaction_equivalent.png" style="width: 60%;" /></a>
<p>Note that this is a subtly different view, the transaction instance shows one particular transition, the State Machine View shows all potential usages of the state in a transition. This is important as the state machine view enables the user of the model to reason about all possible usages, not just a selected subset of usages that are intended as part of the CorDapp design or are explicitly built in the flows.</p>
</div>
<div class="section" id="introducing-constraints">
<h2>Introducing Constraints</h2>
<p>By default, Corda allows any transaction that is not explicitly disallowed. The code to implement Contract constraints is placed in the Contract’s verify() method. If you have a State with a Contract with an empty verify() method, with the exception that the input states must be unconsumed, there are no restrictions over the composition of a transaction using those states.</p>
<p>To have a useful CorDapp, we need to impose constraints over how the States are allowed to evolve. There are multiple types of constraints which we may want to impose on a State and Transactions involving the State, the design language needs to reflect these.</p>
<p>It should be possible to reason that undesirable transitions are not permitted from the constraints in the model. It is envisaged that this will be important tools for audits and security reviews.</p>
<p>We will build up the types of constraints and show how they are represented in the view.</p>
</div>
<div class="section" id="transitions-constraints">
<h2>Transitions Constraints</h2>
<p>The first type of constraint is the allowable transitions as denoted by allowable Commands</p>
<p>If you follow the basic model diagram above, we can see that when an agreement is in Draft it only has two valid transitions: back to Draft via the Amend Command or to Agreed via the AgreeDeal Command. It can’t, for example, move from Cancelled to Agreed.</p>
<p>The language assumption is that if the transition/ Command is not shown on the diagram, it should not be permitted to occur.</p>
</div>
<div class="section" id="state-level-constraints">
<h2>State Level Constraints</h2>
<p>There will be some constraints over the form of an instance of a State that are independent of other components of a transaction. For these we need a more refined box to represent the State:</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_State_level_constraints.png"><img alt="../../_images/CMN2_SM_State_level_constraints.png" class="align-center" src="../../_images/CMN2_SM_State_level_constraints.png" style="width: 30%;" /></a>
<p>The constraint is shown as an orange box attached to the State with the ‘SLC’ Label (State Level Constraint). In the example shown, the constraints are:</p>
<blockquote>
<div><ul class="simple">
<li>(If the state status is Draft) Buyer, Seller and Goods must be populated</li>
<li>The Seller and Buyer must not be the same Party</li>
</ul>
</div></blockquote>
<p>Note that the State Level Constraints are status dependent.</p>
<p>Importantly, State level Constraints would not include constraints which need to look outside of the instance of the State. For example, the input State and output State must be the same apart from property X, would note be state level as this looks across two instances, even though they are the same type of State.</p>
</div>
<div class="section" id="transaction-level-constraints">
<h2>Transaction Level Constraints</h2>
<p>Transaction Level Constraints work over the whole of the Transaction. They are shown as orange boxes. Any information in a transaction can form the subject of the constraint.</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Transaction_level_constraints.png"><img alt="../../_images/CMN2_SM_Transaction_level_constraints.png" class="align-center" src="../../_images/CMN2_SM_Transaction_level_constraints.png" style="width: 60%;" /></a>
<p>These could include:</p>
<blockquote>
<div><ul class="simple">
<li>Permitted changes between input and output versions of the same type of State</li>
<li>Requirements that a particular type of State is include in the Transaction</li>
<li>Requirements that a specified Command is included in the Transaction</li>
</ul>
</div></blockquote>
<p>As the nature of the Transaction changes based on the Command invoked, the Transaction Level Constraints are represented as being attached to the Command.</p>
<p>The total Transaction Level Constraints in a given Transaction is the union of the Transaction Level Constraints attached to all Commands in the Transaction from all the Contracts attached to the States in the Transaction.</p>
<p>Note, Transitions, Required Signatures, Visibility and Multiplicity constraints are also type of Transaction Level Constraints, but these have special importance so are shown separately to aid understanding. We want to avoid just having a big list of constraints as this is hard to visually take in and reason about.</p>
</div>
<div class="section" id="required-signers-constraints">
<h2>Required Signers Constraints</h2>
<p>Required signers are denoted in brackets after the Command which defines the transition.</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Signing_constraints_inline.png"><img alt="../../_images/CMN2_SM_Signing_constraints_inline.png" class="align-center" src="../../_images/CMN2_SM_Signing_constraints_inline.png" style="width: 60%;" /></a>
<p>The restriction could be stated as a specific Party, but is more likely to be a role defined with in the state.</p>
<p>In more complicated examples, the constraint might be conditional, if more space is reuquired an orange constraint box can be used, annotated with ‘SC’ and attached to the Command.</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Signing_constraints_box.png"><img alt="../../_images/CMN2_SM_Signing_constraints_box.png" class="align-center" src="../../_images/CMN2_SM_Signing_constraints_box.png" style="width: 60%;" /></a>
</div>
<div class="section" id="visibility-constraints">
<h2>Visibility Constraints</h2>
<p>A key differentiator for Corda compared to other Distributed Ledger Technologies is its peer to peer privacy so it is important to be able to model the Visibility Constraints of a CorDapp. This will become crucial when reasoning about the privacy of a CorDapp.</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Visibility_constraints.png"><img alt="../../_images/CMN2_SM_Visibility_constraints.png" class="align-center" src="../../_images/CMN2_SM_Visibility_constraints.png" style="width: 30%;" /></a>
<p>Visibility constraints are show in orange boxes attached to the state, annotated with VC (Visibility Constraint). They specify the restrictions on which Parties should and, importantly, which Parties should not receive a copy of the State.</p>
<p>Corda will distribute a copy of the Transaction to the union of participants in all the States in the Transaction. Visibility Constraints are restrictions on who should be in the total participants list for the Transaction, not just the participant list for the State whose contract imposes the restriction.</p>
<p>Note, there is nothing stopping a Party distributing a copy of a transaction to any other party, in the same way that a party to a regular legal transaction could show a competitor the details of a confidential deal. Hence, where there is a constraint that a specified party cannot see a State, there is no absolute guarantee that they won’t see it through some other means, only that Corda will not automatically distribute the State to that Party.</p>
<p>The purpose of imposing Visibility Constraints is to stop CorDapps inadvertently sharing confidential information thorough inappropriate design decisions.</p>
<p>Privacy in CorDapps and on Corda Networks is not straight forward to reason about. The resolution of historic state chains to prove the provenance of input states brings in complex privacy considerations, these are discussed in the CDL section on Privacy.</p>
</div>
<div class="section" id="multiplicity-constraints">
<h2>Multiplicity Constraints</h2>
<p>So far, we have only looked at a single instance of a State, however, in production CorDapps there may be multiple interacting instances of the same State Type.</p>
<p>To describe this, we can add multiplicities to the Transition’s arrows.</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Multiplicity_constraints.png"><img alt="../../_images/CMN2_SM_Multiplicity_constraints.png" class="align-center" src="../../_images/CMN2_SM_Multiplicity_constraints.png" style="width: 80%;" /></a>
<p>Beginning of the arrow:</p>
<blockquote>
<div><ul class="simple">
<li><strong>0</strong> : There are no input States of this type in the Transaction.</li>
<li><strong>1</strong> : There is exactly one input State of this type in the Transaction.</li>
<li><strong>n</strong> : There are n input States of this type in the Transaction.</li>
</ul>
</div></blockquote>
<p>End of the arrow:</p>
<blockquote>
<div><ul class="simple">
<li><strong>0</strong> : There are no output States of this type in the Transaction.</li>
<li><strong>1</strong> : There is exactly one output State of this type in the Transaction.</li>
<li><strong>1: Matched</strong> : There is exactly one output State of this type in the Transaction and the output State’s linearId must match the input State’s LinearId.</li>
<li><strong>m</strong> : There are m output States of this type in the Transaction.</li>
</ul>
</div></blockquote>
<p>The options above can be combined to form ranges, eg</p>
<blockquote>
<div><ul class="simple">
<li><strong>0..n</strong> : Zero to n input/ output States</li>
</ul>
</div></blockquote>
<p>With fungible assets such as Cash you can have many cash input states and many cash outputs as long as the cash amounts balance across the transaction. This would be expressed as 1..n going to 1 ..m on the Pay transition, with a Transaction Level Constraint keeping the inputs and output amounts equal:</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Cash_example.png"><img alt="../../_images/CMN2_SM_Cash_example.png" class="align-center" src="../../_images/CMN2_SM_Cash_example.png" style="width: 60%;" /></a>
</div>
<div class="section" id="mapping-to-the-code">
<h2>Mapping to the code</h2>
<p>Constraints are implemented in the Corda Contract associated with the Corda State.</p>
<p>The Contract verify() method’s behaviour is usually parameterised on the Command usually via a Kotlin ‘when’ statement (or a ‘switch-case’ statement if you are using Java). State level Constraints are independent of the Command used and can be applied outside of the ‘when’ statement. Transaction Level Constraints, including Required signers, Visibility and Multiplicity Constraints are specified within the ‘when’ branch corresponding to the Command.</p>
<p>For example:</p>
<div class="highlight-kotlin notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AgreementContract</span> <span class="p">:</span> <span class="n">Contract</span> <span class="p">{</span>

    <span class="k">interface</span> <span class="nc">Commands</span> <span class="p">:</span> <span class="n">CommandData</span> <span class="p">{</span>
        <span class="k">class</span> <span class="nc">Draft</span> <span class="p">:</span> <span class="n">TypeOnlyCommandData</span><span class="p">(),</span> <span class="n">Commands</span>
        <span class="k">class</span> <span class="nc">Amend</span> <span class="p">:</span> <span class="n">TypeOnlyCommandData</span><span class="p">(),</span> <span class="n">Commands</span>
        <span class="k">class</span> <span class="nc">AgreeDeal</span> <span class="p">:</span> <span class="n">TypeOnlyCommandData</span><span class="p">(),</span> <span class="n">Commands</span>
        <span class="k">class</span> <span class="nc">Update</span> <span class="n">Deal</span> <span class="p">:</span> <span class="n">TypeOnlyCommandData</span><span class="p">(),</span> <span class="n">Commands</span>
        <span class="k">class</span> <span class="nc">Cancel</span> <span class="p">:</span> <span class="n">TypeOnlyCommandData</span><span class="p">(),</span> <span class="n">Commands</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">verify</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">LedgerTransaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">requireThat</span> <span class="p">{</span>

            <span class="c1">//*** State Level Constraints, ie Constraints which are independent of the Command ***</span>
        <span class="p">}</span>

        <span class="k">val</span> <span class="py">command</span> <span class="p">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">requireSingleCommand</span><span class="p">&lt;</span><span class="n">MyContract</span><span class="p">.</span><span class="n">Commands</span><span class="p">&gt;()</span>

        <span class="k">when</span> <span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">is</span> <span class="n">Commands</span><span class="p">.</span><span class="n">Draft</span> <span class="p">-&gt;</span> <span class="n">requireThat</span> <span class="p">{</span>

                <span class="c1">//*** Constraints applicable for the Draft transition ***</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="n">Commands</span><span class="p">.</span><span class="n">Amend</span> <span class="p">-&gt;</span> <span class="n">requireThat</span> <span class="p">{</span>

                <span class="c1">//*** Constraints applicable for the Amend transition ***</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="n">Commands</span><span class="p">.</span><span class="n">AgreeDeal</span> <span class="p">-&gt;</span> <span class="n">requireThat</span> <span class="p">{</span>

                <span class="c1">//*** Constraints applicable for the Agree transition ***</span>
            <span class="p">}</span>

            <span class="k">is</span> <span class="n">Commands</span><span class="p">.</span><span class="n">UpdateDeal</span> <span class="p">-&gt;</span> <span class="n">requireThat</span> <span class="p">{</span>

                <span class="c1">//*** Constraints applicable for the UpdateDeal transition ***</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="n">Commands</span><span class="p">.</span><span class="n">Cancel</span> <span class="p">-&gt;</span> <span class="n">requireThat</span> <span class="p">{</span>

                <span class="c1">//*** Constraints applicable for the Cancel transition ***</span>
            <span class="p">}</span>

            <span class="k">else</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">TransactionVerificationException</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Allowed transitions are managed in this case by the ‘when’ statement, if the Command is not in a valid ‘when’ branch then the contract throws an error. However, this is a simplified example which assumes one Command in the Transaction, the logic would be more complicated when multiple Commands can be present.</p>
</div>
<div class="section" id="putting-it-together">
<h2>Putting it together</h2>
<p>We can see each of the concepts above in this example of an AgreementState State Machine view:</p>
<a class="reference internal image-reference" href="../../_images/CMN2_SM_Full_example.png"><img alt="../../_images/CMN2_SM_Full_example.png" class="align-center" src="../../_images/CMN2_SM_Full_example.png" style="width: 100%;" /></a>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="views-common-concepts.html" class="btn btn-neutral float-left" title="Common Concepts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="views-state-evolution.html" class="btn btn-neutral float-right" title="State Evolution (Ledger)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, R3 Limited.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>